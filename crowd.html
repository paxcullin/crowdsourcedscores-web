<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/crowdsourcedscores-icon.png">
    <link rel="icon" type="image/png" href="assets/img/crowdsourcedscores-icon.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="description" content="Beating the sportsbooks with the Wisdom of the Crowd NFL Score Predictions">
    <meta name="keywords" content="football,crowdsourced,wisdom,wisdom of the crowd,sportsbook,spread,total,moneyline">
    <base href="https://crowdsourcedscores.com">

    <title>Crowd Wisdom Sports - Beating the Sportsbooks through Crowd Wisdom</title>

    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'/>

    <!--     Fonts and icons     -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css"/>

    <!-- CSS Files -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="assets/css/material-kit.css" rel="stylesheet"/>
    <link href="assets/css/cws.css" rel="stylesheet"/>


    <!--   Core JS Files   -->
    <script src="assets/js/jquery.min.js" type="text/javascript"></script>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        
        ga('create', 'UA-69748662-2', 'auto');
        ga('send', 'pageview');
    </script>


    <script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="assets/js/material.min.js"></script>
    <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
    <script src="assets/js/nouislider.min.js" type="text/javascript"></script>

    <!--  Plugin for the Datepicker, full documentation here: http://www.eyecon.ro/bootstrap-datepicker/ -->
    <script src="assets/js/bootstrap-datepicker.js" type="text/javascript"></script>

    <!-- Control Center for Material Kit: activating the ripples, parallax effects, scripts from the example pages etc -->
    <script src="assets/js/material-kit.js" type="text/javascript"></script>

    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>-->
    <!--Cognito Code-->
    <script type="text/javascript" src="assets/js/amazon-cognito-identity.js"></script>
    <!--End Cognito Code-->
    <!--JWT Decode Script-->
    <script src="assets/js/jwt-decode.min.js"></script>
    <script src="assets/js/userAuth.js"></script>
    <!--End JWT Decode Script-->

    <!-- Handlebars.js -->
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.js"></script>
        

    <script type="text/javascript">
        Handlebars.registerHelper('grouped_each', function(every, context, options) {
            var out = "", subcontext = [], i;
            if (context && context.length > 0) {
                for (i = 0; i < context.length; i++) {
                    if (i > 0 && i % every === 0) {
                        out += options.fn(subcontext);
                        subcontext = [];
                    }
                    subcontext.push(context[i]);
                }
                out += options.fn(subcontext);
            }
            return out;
        });

        Handlebars.registerHelper('ifCond', function (v1, operator, v2, options) {

            switch (operator) {
                case '==':
                    return (v1 == v2) ? options.fn(this) : options.inverse(this);
                case '===':
                    return (v1 === v2) ? options.fn(this) : options.inverse(this);
                case '!=':
                    return (v1 != v2) ? options.fn(this) : options.inverse(this);
                case '!==':
                    return (v1 !== v2) ? options.fn(this) : options.inverse(this);
                case '<':
                    return (v1 < v2) ? options.fn(this) : options.inverse(this);
                case '<=':
                    return (v1 <= v2) ? options.fn(this) : options.inverse(this);
                case '>':
                    return (v1 > v2) ? options.fn(this) : options.inverse(this);
                case '>=':
                    return (v1 >= v2) ? options.fn(this) : options.inverse(this);
                case '&&':
                    return (v1 && v2) ? options.fn(this) : options.inverse(this);
                case '||':
                    return (v1 || v2) ? options.fn(this) : options.inverse(this);
                default:
                    return options.inverse(this);
            }
        });

        Handlebars.registerHelper("math", function(lvalue, operator, rvalue, options) {
            lvalue = parseFloat(lvalue);
            rvalue = parseFloat(rvalue);
                
            return {
                "+": lvalue + rvalue,
                "-": lvalue - rvalue,
                "*": lvalue * rvalue,
                "/": lvalue / rvalue,
                "%": lvalue % rvalue
            }[operator];
        });

        Handlebars.registerHelper("rowColor", function(indexValue) {
            console.log("(indexValue % 2): ", (indexValue % 2))
            if ((indexValue % 2) === 0) {
                return new Handlebars.SafeString("class=\"alt-tr\"");
            }
        });

        var gameWeeks = [
            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17
        ]
    </script>

        <script id="games-template" type="text/x-handlebars-template">
            <div class="container">
                <div class="row">
                {{#grouped_each 2 games}}
                    {{#each this}}
                    <div class="col-md-4 col-sm-12" id="container-{{{gameId}}}">
                        <div class="card prediction" style="margin-bottom:10px;min-width: 293px;" data-game-id="{{{gameId}}}"
                            data-game-week="{{{gameWeek}}}"
                            data-game-year="{{{year}}}"
                            data-home-code="{{{homeTeam.code}}}"
                            data-home-name="{{{homeTeam.fullName}}}" data-home-short="{{{homeTeam.shortName}}}"
                            data-away-code="{{{awayTeam.code}}}"
                            data-away-name="{{{awayTeam.fullName}}}" data-away-short="{{{awayTeam.shortName}}}"
                            {{#if prediction.awayTeam.score}} data-predicted="true" {{/if}}
                            style="display: inline-block;">
                            <div class="content">
                                <div class="tab-content text-center">
                                    <div class="tab-pane active">
                                        <div class="prediction-message" data-game-id="{{{gameId}}}"></div>
                                        <div>
                                            <div class="form-group">
                                                <p{{#if prediction}} class="gameHeaderPredicted"{{/if}}{{#unless prediction}} class="gameHeaderNotPredicted"{{/unless}}>Game {{gameId}}<br/>{{startDateTime}}<br/>{{tvStation}}</p>
                                            </div>
                                        </div>

                                            {{#if results}}<div class="finalRow">FINAL</div>{{/if}}

                                        <table class="table">
                                            <thead>
                                            <tr>
                                                <th></th>
                                                <th>Our Crowd</th>
                                                <th>The Crowd</th>
                                                <th>Odds</th>
                                                <th>{{#unless results}}Pick{{/unless}}{{#if results}}Actual{{/if}}</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr class="predictionRow">
                                                <td><i class="fa fa-plane" aria-hidden="true"></i> {{awayTeam.code}}</td>
                                                <td class="away-team-prediction {{#if results}}{{#ifCond results.awayTeam.score '>' results.homeTeam.score}}{{#ifCond prediction.awayTeam.score '>' prediction.homeTeam.score}} alert alert-success{{/ifCond}}{{/ifCond}}{{/if}}" id="{{{awayTeam.code}}}-prediction">
                                                        {{prediction.awayTeam.score}}
                                                </td>
                                                <td{{#if results}}{{#ifCond results.awayTeam.score '>' results.homeTeam.score}}{{#ifCond crowd.awayTeam.score '>' crowd.homeTeam.score}} class="crowdCorrect"{{/ifCond}}{{/ifCond}}{{/if}}>
                                                    <span
                                                        {{#unless prediction}}
                                                            {{#unless results}}
                                                            class="crowdHidden"
                                                            {{/unless}}
                                                        {{/unless}}>
                                                        {{crowd.awayTeam.score}}
                                                    </span>
                                                    {{#unless prediction}}
                                                        {{#unless results}}
                                                            <span class="fa fa-lock crowdShown"></span>
                                                        {{/unless}}
                                                    {{/unless}}
                                                </td>
                                                <td></td>
                                                <td>{{results.awayTeam.score}}</td>
                                            </tr>
                                            <tr class="predictionRow">
                                                <td><i class="fa fa-home" aria-hidden="true"></i> {{homeTeam.code}}</td>
                                                <td class="home-team-prediction{{#if results}}{{#ifCond results.homeTeam.score '>' results.awayTeam.score}}{{#ifCond prediction.homeTeam.score '>' prediction.awayTeam.score}} alert alert-success{{/ifCond}}{{/ifCond}}{{/if}}" id="{{{homeTeam.code}}}-prediction">
                                                   {{prediction.homeTeam.score}}
                                                </td>
                                                <td
                                                    {{#if results}}
                                                        {{#ifCond results.homeTeam.score '>' results.awayTeam.score}}
                                                            {{#ifCond crowd.homeTeam.score '>' crowd.awayTeam.score}}
                                                            class="crowdCorrect"
                                                            {{/ifCond}}
                                                        {{/ifCond}}
                                                    {{/if}}>
                                                    <span
                                                    {{#unless prediction}}
                                                        {{#unless results}}
                                                         class="crowdHidden"
                                                        {{/unless}}
                                                    {{/unless}}>{{crowd.homeTeam.score}}
                                                    </span>
                                                    {{#unless prediction}}
                                                        {{#unless results}}
                                                            <span class="fa fa-lock crowdShown"></span>
                                                        {{/unless}}
                                                    {{/unless}}
                                                </td>
                                                <td>
                                                    <span
                                                    {{#unless prediction}}
                                                        {{#unless results}}
                                                         class="crowdHidden"
                                                        {{/unless}}
                                                    {{/unless}}>
                                                    {{#ifCond odds.spread '>' 0}}+{{/ifCond}}{{odds.spread}}
                                                    </span>
                                                </td>
                                                <td>{{results.homeTeam.score}}</td>
                                            </tr>
                                            <tr class="predictionRow">
                                                <td>Total</td>
                                                <td{{#if results}}
                                                    {{#ifCond prediction.total '>' odds.total}}
                                                        {{#ifCond results.total '>' odds.total}}
                                                            class="alert alert-success"
                                                        {{/ifCond}}
                                                    {{/ifCond}}
                                                    {{#ifCond odds.total '>' prediction.total}}
                                                        {{#ifCond odds.total '>' results.total}}
                                                        class="alert alert-success"
                                                        {{/ifCond}}
                                                    {{/ifCond}}
                                                {{/if}} id="{{{awayTeam.code}}}{{{homeTeam.code}}}-total-prediction">{{prediction.total}}</td>
                                                <td{{#if results}}{{#ifCond crowd.total '>' odds.total}}{{#ifCond results.total '>' odds.total}} class="crowdCorrect"{{/ifCond}}{{/ifCond}}{{#ifCond odds.total '>' crowd.total}}{{#ifCond odds.total '>' results.total}} class="crowdCorrect"{{/ifCond}}{{/ifCond}}{{/if}}>
                                                    <span
                                                        {{#unless prediction}}
                                                            {{#unless results}} class="crowdHidden"
                                                            {{/unless}}
                                                        {{/unless}}>{{crowd.total}}
                                                    </span>
                                                    {{#unless prediction}}
                                                        {{#unless results}}
                                                            <span class="fa fa-lock crowdShown"></span>
                                                        {{/unless}}
                                                    {{/unless}}</td>
                                                <td>
                                                    <span
                                                    {{#unless prediction}}
                                                        {{#unless results}}
                                                         class="crowdHidden"
                                                        {{/unless}}
                                                    {{/unless}}>{{odds.total}}</span></td>
                                                <td>
                                                    {{#unless results}}
                                                        <span style="font-weight:bold">{{#ifCond odds.total '!=' ""}}{{#ifCond crowd.total '>' odds.total}}Over{{/ifCond}}{{#ifCond crowd.total '<' odds.total}}Under{{/ifCond}}{{/ifCond}}</span>
                                                    {{/unless}}
                                                    {{#if results}}
                                                        {{results.total}}
                                                    {{/if}}</td>
                                            </tr>
                                            <tr class="predictionRow">
                                                <td>Spread</td>
                                                <td{{#if results}}{{#ifCond prediction.results.spread '===' 1}} class="alert alert-success"{{/ifCond}}{{/if}} id="{{{awayTeam.code}}}{{{homeTeam.code}}}-spread-prediction">{{#ifCond prediction.spread '>' 0}}+{{/ifCond}}{{prediction.spread}}</td>
                                                <td{{#if results}}{{#ifCond crowd.spread '>' odds.spread}}{{#ifCond results.spread '>' odds.spread}} class="crowdCorrect"{{/ifCond}}{{/ifCond}}{{#ifCond odds.spread '>' crowd.spread}}{{#ifCond odds.spread '>' results.spread}} class="crowdCorrect"{{/ifCond}}{{/ifCond}}{{/if}}>
                                                    <span
                                                    {{#unless prediction}}
                                                        {{#unless results}}
                                                         class="crowdHidden"
                                                        {{/unless}}
                                                    {{/unless}}>
                                                        {{#ifCond crowd.spread '>' 0}}+{{/ifCond}}{{crowd.spread}}
                                                    </span>
                                                    {{#unless prediction}}
                                                        {{#unless results}}
                                                            <span class="fa fa-lock crowdShown"></span>
                                                        {{/unless}}
                                                    {{/unless}}
                                                </td>
                                                <td>
                                                        <span
                                                        {{#unless prediction}}
                                                            {{#unless results}}
                                                             class="crowdHidden"
                                                            {{/unless}}
                                                        {{/unless}}>{{#ifCond odds.spread '!=' 0}}{{#ifCond odds.spread '>' 0}}+{{/ifCond}}{{odds.spread}}{{/ifCond}}{{#ifCond odds.spread '===' 0}}Even{{/ifCond}}</span></td>
                                                <td>
                                                    {{#unless results}}
                                                        <span 
                                                        {{#unless prediction}}
                                                            {{#unless results}}
                                                             class="crowdHidden"
                                                            {{/unless}}
                                                        {{/unless}} style="font-weight:bold">
                                                            {{#ifCond odds.spread '!=' ""}}{{#ifCond crowd.spread '>' odds.spread}}{{awayTeam.code}}{{/ifCond}}{{#ifCond crowd.spread '<' odds.spread}}{{homeTeam.code}}{{/ifCond}}{{/ifCond}}
                                                        </span>
                                                    {{/unless}}{{#if results}}{{results.spread}}{{/if}}
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                        <div>
                                            {{#if predictionScore}}
                                                <div class="predictionScore">Prediction Score: {{predictionScore}}</div>
                                            {{/if}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                    <div class="clearfix"></div>
                {{/grouped_each}}
            </div>
            <div id="lastRow" class="row"></div>
            </div>
        </script>
     <!-- {{#unless results}}
                                        <div>
                                            {{#if userAuthenticated}}
                                                {{#dateCheck startDateTime}}
                                                    <button class="prediction-btn btn btn-info">Predict</button>
                                                {{/dateCheck}}
                                            {{/if}}
                                            {{#unless userAuthenticated}}
                                                {{#dateCheck startDateTime}}
                                                    <button type="button" class="btn btn-info" onclick="ga('send','event','login','loginClicked');window.location=('https://crowdsourcedscores.auth.us-west-2.amazoncognito.com/login?response_type=code&client_id=2n15lhk845sucm0k4fejjqcbev&redirect_uri=https://crowdsourcedscores.com')">Log in to Predict</button>
                                                {{/dateCheck}}
                                            {{/unless}}
                                        </div>
                                        {{/unless}} -->
        <script id="group-template" type="text/x-handlebars-template">
            <div class="container">
                <div class="row">
                    <div class="col-xs-12 col-sm-9">
                        <table class="rwd-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>User</th>
                                    <th>Weekly Totals</th>
                                    <th>Prediction Score</th>
                                </tr>
                            </thead>
                            <tbody>
                            {{#each this.groupMembers.groupMembers}}
                                <tr {{rowColor @index}} id="container-{{{this.username}}}">
                                    <td data-th="Rank">{{{math @index '+' 1}}}</td>
                                    <td data-th="User">
                                    {{{this.preferred_username}}}
                                    </td>
                                        <td data-th="Weekly Totals">
                                                {{#each this.results.weekly}}
                                                    Week {{{gameWeek}}}: Winners: {{{winner.correct}}} | Spread: {{{spread.correct}}} | Total: {{{total.correct}}} | Score: {{{predictionScore}}}<br>
                                                {{/each}}
                                        </td>
                                    <td data-th="Prediction Score">{{{this.results.overall.predictionScore}}}</td>
                                </tr>
                            {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </script>
    <script src="https://www.google.com/jsapi" type="text/javascript"></script>

    <script>

        var getGameWeek = function (callback) {
            useToken(function(token) {
                console.log("getGameWeek token: ", token);
                var getGameWeekURL = "https://y5f8dr2inb.execute-api.us-west-2.amazonaws.com/dev/nfl/week";
                var getGameWeekURLOptions = {
                    method: "GET",
                    headers: {
                        'Authorization': token
                    }
                }
                if (token === false) {
                    getGameWeekURL = "https://y5f8dr2inb.execute-api.us-west-2.amazonaws.com/dev/nfl/week/anon"
                    getGameWeekURLOptions = {
                        method: "GET"
                    }
                }
                get(getGameWeekURL, getGameWeekURLOptions)
                .then(function(response) {
                    return response.json();
                })
                .then(function (data) {
                    //data.year = 2017;
                    console.log("gameWeek data: ", data);
                    return callback(data);
                })
                .catch(function(err) {
                    console.log("Error: ", err);
                    return;
                });
            });
        };

        var formatGameTimes = function (games) {
            for (var i = 0; i < games.length; i++) {
                var gameDate = new Date(games[i].startDateTime);
                var options = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit', hour: 'numeric', minute: 'numeric', timeZoneName: 'short' };
                games[i].startDateTime = gameDate.toLocaleString('en-US', options);
            }
            return games;
        }

        var setGameWeek = function (gameWeekData) {
            if (groupParams.groupId) {
                useToken(function(token) {
                    var setGameWeekURL = "https://y5f8dr2inb.execute-api.us-west-2.amazonaws.com/dev/group/nfl/" + gameWeekData.year + "/" + groupParams.groupId + "/games?gameWeek=" + gameWeekData.week;
                    var setGameWeekGetOptions = 
                        {     
                            method: "GET",
                            headers: {
                                    'Authorization': token
                            }
                        }
                        // creating anonymous API call for games
                    if (token === false) {
                        setGameWeekURL = "https://y5f8dr2inb.execute-api.us-west-2.amazonaws.com/dev/nfl/" + gameWeekData.year + "/" + gameWeekData.week + "/games/anon";
                        setGameWeekGetOptions = {     
                            method: "GET"
                        }
                    }
                    get(setGameWeekURL, setGameWeekGetOptions)
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (data) {
                        if (data && data.games && data.games.length > 0) {
                            userInformation.predictionsSubmitted = data.predictionsSubmitted;
                            var totalGames = data.games.length;
                            updateProgressBar(userInformation.predictionsSubmitted, totalGames);
                                $("#games-loading-icon").css("display","none")

                                formatGameTimes(data.games);
                                var games = {games: data.games};
                                console.log("games: ", games)
                                var template = $('#games-template').html();
                                var templateScript = Handlebars.compile(template);
                                var html = templateScript(games);
                                $('#games').html(html);
                        }
                            //drawChart2(year, week);
                            $('.prediction-btn').on('click', function (e) {
                                e.preventDefault();
                                $(this).text('Saving...');
                                var $prediction = $(this).parents('.prediction');
                                var prediction = {
                                    gameId: $prediction.attr('data-game-id'),
                                    gameWeek: $prediction.attr('data-game-week'),
                                    year: $prediction.attr('data-game-year'),
                                    awayTeam: {
                                        code: $prediction.attr('data-away-code'),
                                        fullName: $prediction.attr('data-away-name'),
                                        shortName: $prediction.attr('data-away-short')
                                    },
                                    homeTeam: {
                                        code: $prediction.attr('data-home-code'),
                                        fullName: $prediction.attr('data-home-name'),
                                        shortName: $prediction.attr('data-home-short')
                                    }
                                };
                                var btn = $(this);
                                var predictionElm = $('#games').find("[data-game-id='" + prediction.gameId + "']");
                                var messageElm = predictionElm.find(".prediction-message");
                                

                                var awayTeamPrediction = $prediction.find('.away-team-prediction input').val();
                                var homeTeamPrediction = $prediction.find('.home-team-prediction input').val();

                                var away = $prediction.attr('data-away-team');
                                var home = $prediction.attr('data-home-team');

                                var awayCode = $prediction.attr('data-away-code');
                                var homeCode = $prediction.attr('data-home-code');

                                prediction.awayTeam.score = parseInt(awayTeamPrediction);
                                prediction.homeTeam.score = parseInt(homeTeamPrediction);

                                //submitPrediction(prediction, $(this));
                                useToken(function(token){
                                    console.log("submitPrediction Token: ", token)
                                    apiClient.predictionsPost({},JSON.stringify(prediction),{headers: {Authorization: token}})
                                    .then(function(response) {
                                        console.log("response message:", response)
                                        switch(response.status) {
                                            case 200:
                                                console.log("200: ", response);
                                                btn.text('Predict');
                                                var messageHtml = statusMessage('success', response.data.message);
                                                messageElm.html(messageHtml)
                                                moveBoxes(prediction.gameId);
                                                return;
                                            case 400:
                                                var errorObj = JSON.parse(response.responseText);
                                                console.log("400: ", errorObj);
                                                btn.text('Predict');
                                                var messageHtml = statusMessage('danger', errorObj.message);
                                                messageElm.html(messageHtml);
                                                return;
                                            case 500:
                                                var errorObj = JSON.parse(response.responseText);
                                                console.log("500: ", errorObj);
                                                btn.text('Predict');
                                                var messageHtml = statusMessage('danger', errorObj.message);
                                                messageElm.html(messageHtml);
                                                return;
                                        }
                                        return true;
                                    })
                                    .catch(function(reject) {
                                        console.log("reject message: ", reject)
                                    })
                                })
                                // Update prediction table cell
                                //$('#' + awayCode + '-prediction').text(prediction.awayTeam.score);
                                //$('#' + homeCode + '-prediction').text(prediction.homeTeam.score);
                                $('#' + awayCode + homeCode + '-total-prediction').text(prediction.awayTeam.score + prediction.homeTeam.score);
                                $('#' + awayCode + homeCode + '-spread-prediction').text(prediction.awayTeam.score - prediction.homeTeam.score);
                                //show odds and crowd info
                                $prediction.find('.crowdHidden').removeClass('crowdHidden');
                                $prediction.find('.crowdShown').addClass('crowdHidden').removeClass('crowdShown');
                            });
                            return data;
                        })
                });
            }
        };

        $(document).ready(function () {
            var gameWeekDataObj = {};

            if (cognitoUser) {
                showLogoutButton();
            } else {
                showLoginButton();
            }

            
            if (groupParams.groupId && groupParams.sport && groupParams.year) {
                getGroupInfo();
            } else {
                console.log("no group selected");
                getAllGroups();

                $("#games-loading-icon").css("display","none")
                $("#group-loading-icon").css("display","none")
            }

            $('#weekSelector li').on('click', 'a', function () {
                gameWeekData.year = parseInt(document.getElementById('dropdown').innerText);
                if (!gameWeekData.year) {
                    gameWeekData.year = 2018;
                }
                gameWeekData.week = parseInt($(this).attr('data-week'));
                //show loading icon
                $("#games-loading-icon").css("display","block")
                // remove previous week games
                $("#games").html("");
                
                $('#weekSelector li').removeClass('active');
                $('#resultsContainer').css('display','none');
                $(this).parent('li').addClass('active');
                setGameWeek(gameWeekData);
                //deferredLeaderboardRequest2(gameWeekData.year, gameWeekData.week, id_token, buildChart);
            });


            setTimeout(function () {
                getGameWeek(function (data) {
                    console.log("data: ", data);
                    if (data) {
                        week = data.week;
                        year = parseInt(document.getElementById('seasonSelector').value);
                        if (data.year) {
                            year = data.year;
                        }
                        gameWeekDataObj.week = data.week;
                        gameWeekDataObj.year = data.year;
                        var $selectorElm = $('*[data-week="' + week + '"]');
                        $selectorElm.parent('li').addClass('active');
                        $("#weeklyChartButton").attr({"year":year,"week": week});
                        $("#overallChartButton").attr({"year":year,"week": week});
                        setGameWeek(data);
                        //deferredLeaderboardRequest2(year, week, id_token, buildChart);
                    }
                });
            }, 1000);
            
            $('#newsletter-signup-div').click(function () {
                ga('send','event','newsletter','viewed');

                $header = $(this);
                //getting the next element
                $content = $("#newsletter-form-div");
                //open up the content needed - toggle the slide- if visible, slide up, if not slidedown.
                $content.slideToggle(500, function () {
                    //execute this after slideToggle is done
                    //change text of header based on visibility of content div
                    $header.text(function () {
                        //change text based on condition
                        //return $content.is(":visible") ? "" : "";
                    });
                });
            });

            $('#mc-embedded-subscribe').click(function () {
                ga('send','event','newsletter','subscribed');

                $header = $(this);
                //getting the next element
                $content = $("#newsletter-form-div");
                //open up the content needed - toggle the slide- if visible, slide up, if not slidedown.
                $content.slideToggle(500, function () {
                    //execute this after slideToggle is done
                    //change text of header based on visibility of content div
                    $header.text(function () {
                        //change text based on condition
                        //return $content.is(":visible") ? "" : "";
                    });
                });
            });


            $("#chartExpand").click(function () {

                $header = $(this);
                //getting the next element
                $content = $("#weeklyChart");
                //open up the content needed - toggle the slide- if visible, slide up, if not slidedown.
                $content.slideToggle(500, function () {
                    //execute this after slideToggle is done
                    //change text of header based on visibility of content div
                    $header.text(function () {
                        //change text based on condition
                        //return $content.is(":visible") ? "" : "";
                    });
                });

            });

        });


            $("#loginButton").click(function() {
                $("#loginModal").modal('show',{
                    fadeDuration: 100
                });
            });

        </script>

    </head>

    <body>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0&appId=1562547140702907&autoLogAppEvents=1';
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
    <!-- Navbar will come here -->

    <!-- end navbar -->
    <!--edit crowd modal-->
    <div class="modal fade" id="editCrowdModal" tabindex="-1" role="dialog" aria-labelledby="crowdModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="crowdModalLabel">Edit Crowd Info</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-12" id="createCrowdColumn">
                            <form role="form" class="form-horizontal">
                                <div class="form-group">
                                    <fieldset>
                                        <label for="crowdNameInput">Crowd Name:</label> <input class="form-control" type="text" id="crowdNameInput" name="crowdNameInput">
                                        <span id="updateCrowdResults"></span>
                                    </fieldset>
                                </div>
                            </form>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="editCrowdButton" onclick="editCrowd()">Update</button><br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--close edit crowd modal-->
    <!--invite users modal-->
    <div class="modal fade" id="inviteModal" tabindex="-1" role="dialog" aria-labelledby="inviteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Build Your Crowd</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 col-lg-12" style="border: 1px dotted #C2C2C2;padding-right: 30px;" id="inviteUsersColumn">
                            <!-- Tab panes -->
                            <div class="tab-content">
                                <div class="tab-pane active" id="inviteUsers">
                                    <form role="form" class="form-horizontal">
                                        <div class="form-group">
                                            <fieldset>
                                                <!--<legend>Sign Up for PCSM</legend>-->
                                                <!--User name: <input type="text" id="username" placeholder="Enter your preferred user name">
                                                <br>
                                                <br>-->
                                                Add E-mail Addresses (separate with a semi-colon):<br>
                                                <input type="textarea" id="inviteEmails" placeholder="email@email.com; email2@email.com; email3@email.com">
                                                <br>
                                                <!--<div style="width: 90%;">
                                                    <button id="loginUser">Log In</button>
                                                </div>-->
                                                <ul id="inviteUserResults"></ul>
                                            </fieldset>
                                        </div>
                                    </form>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-primary" id="inviteUsers">Invite Users</button><br>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--close invite users modal-->

    <div class="wrapper">
        <!--<div class="header">-->

        <!--</div>-->
        <!-- you can use the class main-raised if you want the main area to be as a page with shadows -->
        <div class="main">
            <div class="container">
                <div class="row">
                    <div class="navbar navbar-default navbar-fixed-top">
                        <div class="container">
                            <div class="header-icon"><a href="/"><img src="https://crowdsourcedscores.files.wordpress.com/2016/11/cropped-css-logo-footballleft-webres-1300px.jpg?w=520" alt="Crowd Wisdom Sports"></a></div>
                            <div class="navbar-header"><a href="/" class="navbar-brand"><span class="hidden-md">Crowd Wisdom Sports</span><span class="visible-md">CS Scores</span></a>
                            <button type="button" data-toggle="collapse" data-target="#navbar-main" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button>
                            </div>
                            <div id="navbar-main" class="navbar-collapse collapse">
                            <ul class="nav navbar-nav">
                                <li class="active"><a href="#">Home</a></li>
                                <li><a href="https://blog.crowdsourcedscores.com/" target="blog">Blog</a></li>
                                <li><a class="dropdown-toggle" data-toggle="dropdown" href="#" id="leaderboards">Leaderboards<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                        <li style="text-align: center"><a href="/crowd.html"><span class="glyphicons glyphicons-group"></span> Groups</a></li>
                                        <li style="text-align: center"><a href="/leaderboard.html"><span><i class="glyphicon glyphicon-user"></i></span> Users</a></li>
                                    </ul>
                                </li>
                                <li class="dropdown">
                                    <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="podcasts"><i class="fa fa-headphones" aria-hidden="true"></i> Podcast<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                        <li style="text-align: center">
                                            <a target="_blank" href="https://itunes.apple.com/us/podcast/the-crowd-wisdom-sports-podcast/id1331165617?mt=2" style="display:inline-block;overflow:hidden;background:url(https://linkmaker.itunes.apple.com/assets/shared/badges/en-us/podcast-lrg.svg) no-repeat;width:133px;height:34px;background-size:contain;"><span style="height: 34px; width:133px; padding: 16px 0"></span></a>
                                        </li>
                                        <li style="text-align: center">
                                            <a href="https://www.stitcher.com/s?fid=162919&refid=stpr"><img src="https://secureimg.stitcher.com/promo.assets/stitcher-banner-88x31.jpg" width="88" height="31" alt="Listen to Stitcher"></a>
                                        </li>
                                        <li style="text-align: center">
                                            <a target="_blank" href='https://playmusic.app.goo.gl/?ibi=com.google.PlayMusic&amp;isi=691797987&amp;ius=googleplaymusic&amp;apn=com.google.android.music&amp;link=https://play.google.com/music/m/Ikd4ilzctaypo3idfl2admka4ve?t%3DThe_Crowd_Wisdom_Sports_Podcast%26pcampaignid%3DMKT-na-all-co-pr-mu-pod-16' rel='nofollow'><img width='125px' alt='Listen on Google Play Music' src='https://play.google.com/intl/en_us/badges-music/images/badges/en_badge_web_music.png'/></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown">
                                    <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="profileName"><span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                        <li style="text-align: center"><a href="/profile.html"><span><i class="glyphicon glyphicon-user"></i></span> Profile</a></li>
                                        <li style="text-align: center"><button type="button" class="btn btn-default" id="btn-logout" onclick="logout()">Logout</button></li>
                                    </ul>
                                </li>
                            </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row topRow">
                    <div class="col-xs-7 col-sm-10">
                        <!--<a href="https://crowdsourcedscores.auth.us-west-2.amazoncognito.com/login?response_type=token&client_id=2n15lhk845sucm0k4fejjqcbev&redirect_uri=https://crowdsourcedscores.com">Login</a>-->
                        
                        <div id="loginButtons"></div>
    
    
                        <!-- fieldset for Cognito -->
                        <!--<fieldset>
                            <legend>Sign Up for PCSM</legend>
                            User name: <input type="text" id="username" placeholder="Enter your preferred user name">
                            <br>
                            <br>
                            E-mail: <input type="text" id="email" placeholder="Enter your e-mail address">
                            <br>
                            <br>
                            Password: <input type="password" id="password" placeholder="Enter password">
                            <br>
                            <br>
                            <div style="width:500px;">
                                <button id="loginUser">Log In</button>
                            </div>
                            <ul id="loginUserResults"></ul>
                        </fieldset>-->
    
                        <div id="dropdown" class="ddmenu">
                            2018
                        </div>
                    </div>
                    <div class="col-xs-5 col-sm-2">
                        <a href="https://twitter.com/crowdbrains" class="twitter-follow-button" data-show-count="false">Follow @crowdbrains</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script><br>
                        <iframe src="https://www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fcrowdsourcedscores&width=20px&layout=button_count&action=like&size=small&show_faces=false&share=true&height=46&appId=220211628373013" width="160px" height="20" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true"></iframe>
    
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 weekSelector">
    
                        <ul id="weekSelector" class="pagination pagination-info">
                            <li><a href="javascript:void(0);" data-week="1">1</a></li>
                            <li><a href="javascript:void(0);" data-week="2">2</a></li>
                            <li><a href="javascript:void(0);" data-week="3">3</a></li>
                            <li><a href="javascript:void(0);" data-week="4">4</a></li>
                            <li><a href="javascript:void(0);" data-week="5">5</a></li>
                            <li><a href="javascript:void(0);" data-week="6">6</a></li>
                            <li><a href="javascript:void(0);" data-week="7">7</a></li>
                            <li><a href="javascript:void(0);" data-week="8">8</a></li>
                            <li><a href="javascript:void(0);" data-week="9">9</a></li>
                            <li><a href="javascript:void(0);" data-week="10">10</a></li>
                            <li><a href="javascript:void(0);" data-week="11">11</a></li>
                            <li><a href="javascript:void(0);" data-week="12">12</a></li>
                            <li><a href="javascript:void(0);" data-week="13">13</a></li>
                            <li><a href="javascript:void(0);" data-week="14">14</a></li>
                            <li><a href="javascript:void(0);" data-week="15">15</a></li>
                            <li><a href="javascript:void(0);" data-week="16">16</a></li>
                            <li><a href="javascript:void(0);" data-week="17">17</a></li>
                            <!-- <li><a href="javascript:void(0);" data-week="18">WC</a></li>
                            <li><a href="javascript:void(0);" data-week="19">DIV</a></li>
                            <li><a href="javascript:void(0);" data-week="20">CONF</a></li>
                            <li><a href="javascript:void(0);" data-week="21">SB</a></li> -->
                            <li><i class="fa fa-bar-chart" aria-hidden="true" id="chartExpand"></i></li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-9 groupDiv">
                        <div class="row">
                                <div class="col-xs-12 col-sm-6 titleText">
                                    <h3 id="groupTitle"></h3>
                                    <div id="groupDetails"></div>
                                </div>
                                <div class="col-xs-12 col-sm-6" id="joinGroupButtonDiv"></div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-8" id="group">
                                <div id="group-loading-icon">
                                    <i class="fa fa-cog fa-spin fa-3x fa-fw"></i>
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <!-- <div class="col-xs-12 col-sm-4" id="inviteUsersDiv">
                                <button id="inviteUsersButton" data-toggle="modal" data-target="inviteModal">Build Your Crowd</button>
                            </div> -->
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-8" id="games">
                                <div id="games-loading-icon">
                                        <i class="fa fa-cog fa-spin fa-3x fa-fw"></i>
                                        <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="allGroups"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    console.log("cognitoUser: ", cognitoUser)
    var attributeList = [];

    var dataEmail = {
        Name : 'email',
        Value : 'email@mydomain.com'
    };

    var dataUsername = {
        Name : 'preferred_username',
        Value : 'email@mydomain.com'
    };
    var attributeEmail = new AmazonCognitoIdentity.CognitoUserAttribute(dataEmail);
    var attributeUsername = new AmazonCognitoIdentity.CognitoUserAttribute(dataUsername);

    $("#loginUser").click(function() {
        login();
    });
    var login = function () {
        var email = $('#email').val();
        var authenticationData = {
            Username: email,
            Password: $('#password').val()
        };

        var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
        var userData = {
            Username: email,
            Pool: userPool
        };
        var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
        cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: function () {
                $("#loginModal").modal("hide");
                showLogoutButton();
                getGameWeek(setGameWeek)
            },
            onFailure: function (err) {
                console.log(JSON.stringify(err))
                alert(JSON.stringify(err));
                if (err.code === "NotAuthorizedException") {
                    console.log(CognitoUser.resendConfirmationCode(email))
                }
            }
        });
    }

    // Commenting out and will remove once login flow is confirmed

    // document.getElementById('signUpUser').addEventListener('click', function() {
    //     console.log('clicked');
    //     var attributeList = [];
        
    //     var dataEmail = {
    //             Name : 'email',
    //             Value : $('#newEmail').val()
    //         };

    //     var attributeEmail = new AmazonCognitoIdentity.CognitoUserAttribute(dataEmail);
    //     attributeList.push(attributeEmail);
        
    //     var dataFirst = {
    //             Name : 'given_name',
    //             Value : $('#firstName').val()
    //         };

    //     var attributeFirst = new AmazonCognitoIdentity.CognitoUserAttribute(dataFirst);
    //     attributeList.push(dataFirst);

    //     var dataLast = {
    //             Name : 'family_name',
    //             Value : $('#lastName').val()
    //         };

    //     var attributeFirst = new AmazonCognitoIdentity.CognitoUserAttribute(dataLast);
    //     attributeList.push(dataLast);

    //     var cognitoUser;

    //     userPool.signUp($('#newUsername').val(), $('#newPassword').val(), attributeList, null, function(err, result) {
    //         if (err) {
    //             alert(err);
    //             return;
    //         }
    //         cognitoUser = result.user;

    //         console.log('user name is ' + cognitoUser.getUsername());
    //         showConfirmUI(cognitoUser);
    //     });
    // });

    function showConfirmUI(cognitoUser) {
        $("#loginRegistrationColumn").html("<h1>Welcome " + cognitoUser.getUsername() + "!</h1><p>We have sent a confirmation code to the email address that you provided.</p><div><label for=\"confirmUserCode\">Enter your confirmation code:</label><input type=\"number\" id=\"confirmUserCode\"><button class=\"btn btn-primary btn-sm\" id=\"confirmUser\" onclick=\"confirmUser('" + cognitoUser.getUsername() + "')\">Confirm</button><br><a href=\"#\" id=\"resendCode\" onclick=\"resetVerificationPIN('" + cognitoUser.getUsername() + "')\">Resend Confirmation Code</a></div>")
    }


    function confirmUser(username) {

        var userData = {
            Username: username,
            Pool: userPool
        };
        var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
        
        cognitoUser.confirmRegistration($('#confirmUserCode').val(), true, function (err, results) {
            if (err) {
                alert(err);
            } else {
                window.location = '/';
            }
        });
    };

    
    function resetVerificationPIN(username){
        const p = new Promise((res, rej)=>{
        
        var userData = {
            Username: username,
            Pool: userPool
        };
        var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

        cognitoUser.resendConfirmationCode(function(err, result) {
            if (err) {
                rej(err)
                return
            }
                res()
            })
        });
    };

    // function getUrlParameter(name) {
    //     name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    //     var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    //     var results = regex.exec(location.search);
    //     return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    // };

    function showForgotPasswordUI() {
        $("#loginRegistrationColumn").html("<div>Please provide your e-mail address and, if it exists in our system, we will send you a link to reset your password.<br><label for=\"forgotPasswordEmail\">Enter your e-mail address:</label><input type=\"email\" id=\"forgotPasswordEmail\"><button class=\"btn btn-primary btn-sm\" id=\"forgotPasswordButton\" onclick=\"forgotPassword()\">Reset Password</button><br></div>")
    }


    function forgotPassword() { 

        var forgotPasswordEmail = $('#forgotPasswordEmail').val()
        var userData = {
            Username: forgotPasswordEmail,
            Pool: userPool
        };
        var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

        cognitoUser.forgotPassword({
            onSuccess: function (result) {
                console.log('call result: ' + result);
                $("#loginRegistrationColumn").html("<div>Enter the confirmation code sent to the e-mail address you provided and your new password.<br><label for=\"forgotPasswordConfirmationCode\">Confirmation Code:</label><input type=\"number\" id=\"forgotPasswordConfirmationCode\"><br><label for=\"forgotPasswordNewPassword\">New Password</label><input type=\"password\" id=\"forgotPasswordNewPassword\"><button class=\"btn btn-primary btn-sm\" id=\"changePasswordButton\" onclick=\"inputVerificationCode('" + forgotPasswordEmail + "')\">Reset Password</button><br></div>")
            },
            onFailure: function(err) {
                console.log(JSON.stringify(err));
            }
        });


        // cognitoUser.confirmRegistration($("#confirmUserCode").val(), true, function(err, result) {
        //         if (err) {
        //             alert(JSON.stringify(err));
        //             return;
        //         }
        //         alert("result: ", JSON.stringify(result));
        //     });
    }

    // function getUrlParameter(name) {
    //     name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    //     var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    //     var results = regex.exec(location.search);
    //     return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    // };

</script>
<!-- CWS Group Files -->
<script src="assets/js/index.js" type="text/javascript"></script>
<script src="assets/js/groups.js" type="text/javascript"></script>

</body>

</html>
